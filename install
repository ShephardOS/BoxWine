#!/bin/bash

clear

echo "BoxWine by ShephardOS"
echo
echo "1) English"
echo "2) Русский"
read -p "Select language / Выберите язык: " lang

if [ "$lang" == "2" ]; then
    msg() { echo "$2"; }
else
    msg() { echo "$1"; }
fi

msg "Starting installation..." "Запуск установки..."

termux-setup-storage >/dev/null 2>&1
sleep 2

while [ ! -d ~/storage/shared ]; do
    msg "Storage access is required. Please grant it." "Требуется доступ к хранилищу. Пожалуйста, предоставьте его."
    sleep 2
done

msg "Installing packages..." "Установка пакетов..."
pkg update -y >/dev/null 2>&1
pkg upgrade -y >/dev/null 2>&1
pkg install wget curl tsu x11-repo pulseaudio xwayland root-repo patchelf p7zip xorg-xrandr ncurses-utils hashdeep termux-x11-nightly xfce4 xfce4-terminal tigervnc -y >/dev/null 2>&1

if [ -d "$PREFIX/glibc" ]; then
    msg "Existing glibc found. Remove? (Y/n)" "Найдена существующая glibc. Удалить? (Y/n)"
    read input
    [ "$input" = "Y" ] || [ "$input" = "y" ] && rm -rf "$PREFIX/glibc" || exit 1
fi

mkdir -p "$PREFIX/glibc/opt/package-manager/installed"

cat <<EOF > "$PREFIX/glibc/opt/package-manager/token"
PRIVATE_TOKEN=glpat-6LE7R9PQ7zb6zsx4x3be
PROJECT_ID=64704412
EOF

. "$PREFIX/glibc/opt/package-manager/token"

download() {
    wget -q --header "PRIVATE-TOKEN: $PRIVATE_TOKEN" "https://gitlab.com/api/v4/projects/$PROJECT_ID/repository/files/$1/raw?ref=main" -O "$2"
}

if ! download "package-manager" "$PREFIX/glibc/opt/package-manager/package-manager"; then
    msg "Failed to download package manager." "Не удалось загрузить менеджер пакетов."
    exit 1
fi

. "$PREFIX/glibc/opt/package-manager/package-manager"
sync-all
sync-package wine-9.3-vanilla-wow64

mkdir -p "$PREFIX/bin"

cat <<EOF > "$PREFIX/bin/boxwine"
#!/bin/bash
export DISPLAY=:0
termux-x11 :0 &
sleep 2
xfce4-session
EOF

chmod +x "$PREFIX/bin/boxwine"

if ! command -v boxwine >/dev/null 2>&1; then
    export PATH="$PREFIX/bin:\$PATH"
    echo "export PATH=\"$PREFIX/bin:\$PATH\"" >> ~/.bashrc
    echo "export PATH=\"$PREFIX/bin:\$PATH\"" >> ~/.zshrc
fi

msg "Installation complete. Run with 'boxwine'" "Установка завершена. Запустите с помощью 'boxwine'"
