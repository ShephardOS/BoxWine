#!/bin/bash

rm ~/x

echo "Установка termux-am"
pkg install termux-am -y &>/dev/null

termux-setup-storage & sleep 4 &>/dev/null

while true; do
    if [ -d ~/storage/shared ]; then
        break
    else
        echo "Доступ к хранилищу не предоставлен"
    fi
    sleep 3
done

echo "Установка пакетов Termux"
apt-get clean
apt-get update >/dev/null 2>&1
apt-get -y --with-new-pkgs -o Dpkg::Options::="--force-confdef" upgrade >/dev/null 2>&1

PACKAGES=(
    x11-repo pulseaudio xwayland wget tsu root-repo patchelf
    p7zip xorg-xrandr ncurses-utils hashdeep termux-x11-nightly
)

for pkg in "${PACKAGES[@]}"; do
    pkg install "$pkg" -y &>/dev/null
done

if [ -e "$PREFIX/glibc" ]; then
    echo -n "Удалить предыдущий glibc? (Y/n) "
    read i
    if [[ "$i" == "Y" || "$i" == "y" ]]; then
        rm -rf "$PREFIX/glibc"
    else
        exit 1
    fi
fi

INSTALL_WOW64=0

echo "Выбери вариант установки:"
echo "1) Установить старый BoxWine с box86"
echo "2) Установить новый BoxWine (WoW64)"
echo ""
echo -n "Выбери номер: "
read i
case "$i" in
1) INSTALL_WOW64=0 ;;
2) INSTALL_WOW64=1 ;;
*) exit 1 ;;
esac

echo "Установка BoxWine"

function wget-git-q {
    wget -q --retry-connrefused --tries=0 "https://gitlab.com/api/v4/projects/$PROJECT_ID/repository/files/$1/raw?ref=main" -O "$2"
    return $?
}

echo "Обновление менеджера пакетов"
mkdir -p "$PREFIX/glibc/opt/package-manager/installed"

if [ "$INSTALL_WOW64" -eq 1 ]; then
    echo "PROJECT_ID=54240888" > "$PREFIX/glibc/opt/package-manager/token"
else
    echo "PROJECT_ID=52465323" > "$PREFIX/glibc/opt/package-manager/token"
fi

. "$PREFIX/glibc/opt/package-manager/token"

if ! wget-git-q "package-manager" "$PREFIX/glibc/opt/package-manager/package-manager"; then
    echo "Ошибка загрузки"
    exit 1
fi

. "$PREFIX/glibc/opt/package-manager/package-manager"
sync-all

if [ "$INSTALL_WOW64" -eq 1 ]; then
    sync-package wine-9.3-vanilla-wow64
else
    sync-package wine-ge-custom-8-25
fi

ln -sf "$PREFIX/glibc/opt/scripts/boxwine" "$PREFIX/bin/boxwine"
echo "Для запуска используй команду: \"boxwine\""
