#!/data/data/com.termux/files/usr/bin/bash

set -e

echo "Удаляем временные файлы..."
rm -f ~/x

echo "Настройка доступа к хранилищу..."
termux-setup-storage &>/dev/null & sleep 4

while true; do
    if [ -d ~/storage/shared ]; then
        break
    else
        echo "Доступ к хранилищу не предоставлен, ожидаем..."
        sleep 3
    fi
done

echo "Обновляем систему и устанавливаем необходимые пакеты..."
pkg update -y
pkg upgrade -y
pkg install -y x11-repo pulseaudio xwayland wget tsu root-repo patchelf p7zip xorg-xrandr ncurses-utils hashdeep termux-x11-nightly
pkg install -y xfce4
pkg install -y tur-repo chromium code-oss

if [ -d "$PREFIX/glibc" ]; then
    echo -n "Найдена старая glibc. Удалить? (Y/n): "
    read answer
    if [[ "$answer" =~ ^[Yy]$ ]]; then
        rm -rf "$PREFIX/glibc"
    else
        echo "Установка прервана."
        exit 1
    fi
fi

echo
echo "Выберите версию BoxWine для установки:"
echo "1) Box86 (32-bit)"
echo "2) Wow64 (64-bit)"
read -p "Введите номер (1 или 2): " choice

if [ "$choice" == "2" ]; then
    wget -q --show-progress -O $PREFIX/glibc.wow64.tar.xz https://github.com/ShephardOS/BoxWine/releases/download/Glibc/glibc.wow64.tar.xz
    tar -xf $PREFIX/glibc.wow64.tar.xz -C $PREFIX
    rm $PREFIX/glibc.wow64.tar.xz
else
    wget -q --show-progress -O $PREFIX/glibc.box86.tar.xz https://github.com/ShephardOS/BoxWine/releases/download/Glibc/glibc.box86.tar.xz
    tar -xf $PREFIX/glibc.box86.tar.xz -C $PREFIX
    rm $PREFIX/glibc.box86.tar.xz
fi

cp $PREFIX/glibc/opt/scripts/boxwine $PREFIX/bin/
chmod +x $PREFIX/glibc/opt/scripts/*
chmod 777 $PREFIX/bin/boxwine

echo "Скачиваем Wine Explorer и скрипты запуска..."

# Скрипт запуска XFCE4
wget -q --show-progress https://raw.githubusercontent.com/LinuxDroidMaster/Termux-Desktops/main/scripts/termux_native/startxfce4_termux.sh
chmod +x startxfce4_termux.sh
ln -sf $HOME/startxfce4_termux.sh $PREFIX/bin/startxfce4

# Скрипт Mobox Launcher
wget -q --show-progress https://raw.githubusercontent.com/LinuxDroidMaster/Termux-Desktops/main/scripts/termux_native/mobox_run.sh
chmod +x mobox_run.sh
ln -sf $HOME/mobox_run.sh $PREFIX/bin/mobox

# Ярлык Wine Explorer
mkdir -p ~/Desktop
cd ~/Desktop
wget -q --show-progress https://raw.githubusercontent.com/LinuxDroidMaster/Termux-Desktops/main/scripts/termux_native/MoboxExplorer.desktop
cd ~

echo
echo "Установка завершена!"
echo "Запуск XFCE4: ./startxfce4_termux.sh"
echo "Запуск WineExploler: ./mobox_run.sh"
