#!/data/data/com.termux/files/usr/bin/bash

# Обновление и установка базовых пакетов
pkg update -y
pkg install x11-repo -y
pkg install termux-x11-nightly -y
pkg install pulseaudio -y
pkg install wget -y

# Установка XFCE4 окружения
pkg install xfce4 -y

# Установка Chromium (опционально)
pkg install tur-repo -y
pkg install chromium -y

# Установка VS Code (опционально)
pkg install code-oss -y

# Скачивание скрипта запуска XFCE4
wget https://raw.githubusercontent.com/LinuxDroidMaster/Termux-Desktops/main/scripts/termux_native/startxfce4_termux.sh
chmod +x startxfce4_termux.sh

# Скачивание и установка Mobox launcher скрипта
cd ~
wget https://raw.githubusercontent.com/LinuxDroidMaster/Termux-Desktops/main/scripts/termux_native/mobox_run.sh
mv mobox_run.sh boxwine
chmod +x boxwine

# Скачивание ярлыка для рабочего стола
mkdir -p ~/Desktop
cd ~/Desktop
wget https://raw.githubusercontent.com/LinuxDroidMaster/Termux-Desktops/main/scripts/termux_native/MoboxExplorer.desktop
cd ~

# ==============================
# Выбор сборки: Box86 или WoW64
# ==============================

echo "Выберите сборку BoxWine:"
echo "1) BoxWine с box86"
echo "2) BoxWine с wow64 (полная версия)"
echo -n "Введите номер: "
read boxwine_choice

case "$boxwine_choice" in
1)
    echo -e "\e[36m[+] Установка BoxWine (box86)...\e[0m"
    wget -q --show-progress -O boxwine.tar.gz https://storage.googleapis.com/boxwine-installation/boxwine.box86.tar.gz
    ;;
2)
    echo -e "\e[36m[+] Установка BoxWine (wow64)...\e[0m"
    wget -q --show-progress -O boxwine.tar.gz https://storage.googleapis.com/boxwine-installation/boxwine.wow64.tar.gz
    ;;
*)
    echo -e "\e[31m[ERR] Неверный выбор.\e[0m"
    exit 1
    ;;
esac

echo -e "\e[33m[i] Распаковка...\e[0m"
mkdir -p $PREFIX/boxwine
tar -xf boxwine.tar.gz -C $PREFIX/boxwine
rm boxwine.tar.gz

chmod +x $PREFIX/boxwine/start.sh
ln -sf $PREFIX/boxwine/start.sh $PREFIX/bin/boxwine

# ==============================
# Установка темы оформления
# ==============================

echo ""
echo "Выберите тему оформления:"
echo "1) Windows 10 Light"
echo "2) Windows 10 Dark"
echo "3) Windows 10 Red Gaming"
echo "4) Windows 10 Purple Space"
echo -n "Введите номер: "
read theme_choice

case "$theme_choice" in
1)
theme_url="https://github.com/AGENT404TRD/BOXVIDRA-EMULATOR/releases/download/Themes/Windows.10.Light.tar.xz"
theme_folder="Windows 10 Light"
;;
2)
theme_url="https://github.com/AGENT404TRD/BOXVIDRA-EMULATOR/releases/download/Themes/Windows.10.Dark.tar.xz"
theme_folder="Windows 10 Dark"
;;
3)
theme_url="https://github.com/AGENT404TRD/BOXVIDRA-EMULATOR/releases/download/Themes/Windows.10.Red.tar.xz"
theme_folder="Windows 10 Red"
;;
4)
theme_url="https://github.com/AGENT404TRD/BOXVIDRA-EMULATOR/releases/download/Themes/Windows.10.Purple.tar.xz"
theme_folder="Windows 10 Purple"
;;
*)
echo "Неверный выбор. Пропускаем установку темы."
theme_folder=""
;;
esac

if [ -n "$theme_folder" ]; then
echo "Скачиваем тему $theme_folder..."
wget -q --show-progress -O theme.tar.xz "$theme_url"
tar -xf theme.tar.xz
cd "$theme_folder"
cp -r .icons ~/.icons 2>/dev/null
cp -r .themes ~/.themes 2>/dev/null
cp -r WALLPAPERS ~/ 2>/dev/null
cp -r BOXVIDRA-CFG ~/ 2>/dev/null
cp -r APPLICATIONS ~/ 2>/dev/null
cp PROGRAMS/* ~/Desktop/ 2>/dev/null
[ -f .config.tar.xz ] && tar -xf .config.tar.xz -C ~
[ -f Windows-10-master.zip ] && unzip -q Windows-10-master.zip -d $PREFIX/share/icons
cd ..
rm -rf "$theme_folder" theme.tar.xz
echo "Тема $theme_folder установлена!"
fi

echo
echo "Установка завершена!"
echo "Запуск XFCE4: ./startxfce4_termux.sh"
echo "Запуск Wine Explorer: ./boxwine explorer"
