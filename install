#!/bin/bash

rm -f ~/x
clear

echo "BoxWine Setup by ShephardOS"
echo
echo "1) English"
echo "2) Русский"
read -p "Select language / Выберите язык: " lang_choice

if [ "$lang_choice" == "2" ]; then
    lang="ru"
else
    lang="en"
fi

msg() {
    case $lang in
        en) echo "$1" ;;
        ru) echo "$2" ;;
    esac
}

msg "Initializing setup..." "Инициализация установки..."

pkg install termux-am -y &>/dev/null
pkg install wget -y &>/dev/null
clear
termux-setup-storage &>/dev/null
sleep 4

while [ ! -d ~/storage/shared ]; do
    msg "Storage access is required. Please grant permission." "Требуется доступ к хранилищу. Пожалуйста, предоставьте доступ."
    sleep 3
done

msg "Installing necessary packages..." "Установка необходимых пакетов..."

apt-get clean
apt-get update -y >/dev/null 2>&1
apt-get upgrade -y >/dev/null 2>&1

packages=(
    x11-repo pulseaudio xwayland wget tsu root-repo patchelf 
    p7zip xorg-xrandr ncurses-utils hashdeep termux-x11-nightly 
)

for pkg in "${packages[@]}"; do
    pkg install "$pkg" -y &>/dev/null
done

if [ -d "$PREFIX/glibc" ]; then
    msg "Remove existing glibc? (Y/n)" "Удалить существующий glibc? (Y/n)"
    read i
    [[ "$i" =~ ^[Yy]$ ]] && rm -rf "$PREFIX/glibc" || exit 1
fi

msg "Configuring package manager..." "Настройка пакетного менеджера..."

mkdir -p "$PREFIX/glibc/opt/package-manager/installed"

cat <<EOF > "$PREFIX/glibc/opt/package-manager/token"
PRIVATE_TOKEN=glpat-6LE7R9PQ7zb6zsx4x3be
PROJECT_ID=64704412
EOF

. "$PREFIX/glibc/opt/package-manager/token"

wget_git() {
    wget -q --header "PRIVATE-TOKEN: $PRIVATE_TOKEN" \
    "https://gitlab.com/api/v4/projects/$PROJECT_ID/repository/files/$1/raw?ref=main" -O "$2"
}

if ! wget_git "package-manager" "$PREFIX/glibc/opt/package-manager/package-manager"; then
    msg "Failed to download package manager." "Не удалось загрузить пакетный менеджер."
    exit 1
fi

. "$PREFIX/glibc/opt/package-manager/package-manager"
sync-all
sync-package wine-9.3-vanilla-wow64

mkdir -p "$PREFIX/bin"

cat <<EOF > "$PREFIX/bin/boxwine"
#!/bin/bash
export DISPLAY=:0
termux-x11 :0 &
sleep 2
xfce4-session
EOF

chmod +x "$PREFIX/bin/boxwine"

if ! command -v boxwine >/dev/null 2>&1; then
    export PATH="$PREFIX/bin:$PATH"
    echo "export PATH=\"$PREFIX/bin:\$PATH\"" >> ~/.bashrc
    echo "export PATH=\"$PREFIX/bin:\$PATH\"" >> ~/.zshrc
    msg "PATH updated. Please restart Termux or run 'source ~/.bashrc'." \
        "Путь обновлён. Пожалуйста, перезапустите Termux или выполните 'source ~/.bashrc'."
fi

msg "Installation complete! To start, type 'boxwine'" "Установка завершена! Для запуска введите 'boxwine'"
