#!/bin/bash

rm ~/x

echo "Installing required packages..."
pkg update -y &>/dev/null
pkg upgrade -y &>/dev/null
pkg install -y x11-repo pulseaudio xwayland wget tsu root-repo patchelf p7zip xorg-xrandr ncurses-utils hashdeep termux-x11-nightly git &>/dev/null

echo "Setting up storage access..."
termux-setup-storage & sleep 4

while true; do
    if [ -d ~/storage/shared ]; then
        break
    else
        echo "Storage permission denied, retrying..."
    fi
    sleep 3
done

if [ -e $PREFIX/glibc ]; then
    echo -n "Removing previous glibc installation. Continue? (Y/n) "
    read i
    if [ "$i" = "Y" ] || [ "$i" = "y" ]; then
        rm -rf $PREFIX/glibc
    else
        exit 1
    fi
fi

echo "Downloading and installing BoxWine..."

function wget-git-q {
    wget -q --retry-connrefused --tries=0 --header "PRIVATE-TOKEN:glpat-kj--11qKof3MZXBayzRV" "https://gitlab.com/api/v4/projects/67374933/repository/files/$1/raw?ref=main" -O $2
    return $?
}

mkdir -p $PREFIX/glibc/opt/package-manager/installed
echo "PRIVATE_TOKEN=glpat-kj--11qKof3MZXBayzRV"
"PROJECT_ID=67374933" > $PREFIX/glibc/opt/package-manager/token

. $PREFIX/glibc/opt/package-manager/token

if ! wget-git-q "package-manager" "$PREFIX/glibc/opt/package-manager/package-manager"; then
    echo "Download failed"
    exit 1
fi

. $PREFIX/glibc/opt/package-manager/package-manager
sync-all
sync-package wine-9.3-vanilla-wow64

echo "Setting up MangoHud for FPS monitoring..."
git clone --recurse-submodules https://github.com/flightlessmango/MangoHud.git ~/MangoHud
cd ~/MangoHud
meson setup build
ninja -C build install
export MANGOHUD=1
export MANGOHUD_CONFIG="fps"

echo "Installing DXVK for better DirectX performance..."
git clone https://github.com/doitsujin/dxvk.git ~/dxvk
cd ~/dxvk
./setup_dxvk.sh install

echo "Enabling Esync and Fsync optimizations..."
echo "export WINEESYNC=1" >> ~/.bashrc
echo "export WINEFSYNC=1" >> ~/.bashrc
source ~/.bashrc

ln -sf $PREFIX/glibc/opt/scripts/boxwine $PREFIX/bin/boxwine
echo "BoxWine installation complete. To start, type 'boxwine'."
