#!/data/data/com.termux/files/usr/bin/bash

# Обновление и установка базовых пакетов
pkg update -y
pkg install x11-repo -y
pkg install termux-x11-nightly -y
pkg install pulseaudio -y
pkg install wget -y
pkg install xfce4 -y
pkg install tur-repo -y
pkg install chromium -y
pkg install code-oss -y

# Выбор версии Mobox: box86 или WOW64
echo
echo "Выберите версию Mobox:"
echo "1) Mobox с box86"
echo "2) Mobox WOW64 с box64"
read -p "Выбор [1-2]: " choice

mkdir -p $PREFIX/glibc/opt/package-manager/installed
if [ "$choice" = "2" ]; then
    echo "PROJECT_ID=54240888" > $PREFIX/glibc/opt/package-manager/token
else
    echo "PROJECT_ID=52465323" > $PREFIX/glibc/opt/package-manager/token
fi

. $PREFIX/glibc/opt/package-manager/token

# Функция для скачивания из GitLab
wget-git-q() {
    wget -q --retry-connrefused --tries=0 "https://gitlab.com/api/v4/projects/$PROJECT_ID/repository/files/$1/raw?ref=main" -O $2
    return $?
}

# Скачивание и запуск package-manager
if ! wget-git-q "package-manager" "$PREFIX/glibc/opt/package-manager/package-manager"; then
    echo "Ошибка загрузки package-manager"
    exit 1
fi

. $PREFIX/glibc/opt/package-manager/package-manager
sync-all

# Установка выбранной версии Wine
if [ "$choice" = "2" ]; then
    sync-package wine-9.3-vanilla-wow64
else
    sync-package wine-ge-custom-8-25
fi

ln -sf $PREFIX/glibc/opt/scripts/mobox $PREFIX/bin/mobox

# Теперь скачиваем скрипт запуска XFCE и ярлык
cd ~
wget https://raw.githubusercontent.com/LinuxDroidMaster/Termux-Desktops/main/scripts/termux_native/startxfce4_termux.sh
chmod +x startxfce4_termux.sh

wget https://raw.githubusercontent.com/LinuxDroidMaster/Termux-Desktops/main/scripts/termux_native/mobox_run.sh -O boxwine
chmod +x boxwine

mkdir -p ~/Desktop
cd ~/Desktop
wget https://raw.githubusercontent.com/LinuxDroidMaster/Termux-Desktops/main/scripts/termux_native/MoboxExplorer.desktop
cd ~

echo
echo "Установка завершена!"
echo "Запуск XFCE4: ./startxfce4_termux.sh"
echo "Запуск Wine Explorer: ./boxwine explorer"
