#!/bin/bash

echo "Installing termux-am"
pkg install termux-am -y &>/dev/null

rm ~/x

termux-setup-storage & sleep 4 &>/dev/null

while true; do
    if [ -d ~/storage/shared ]; then
        break
    else
        echo "Storage permission denied"
    fi
    sleep 3
done

apt-get clean
apt-get update >/dev/null 2>&1
apt-get -y --with-new-pkgs -o Dpkg::Options::="--force-confdef" upgrade >/dev/null 2>&1
pkg install x11-repo -y &>/dev/null
pkg install pulseaudio -y &>/dev/null
pkg install xwayland -y &>/dev/null
pkg install wget -y &>/dev/null
pkg install tsu -y &>/dev/null
pkg install root-repo -y &>/dev/null
pkg install patchelf -y &>/dev/null
pkg install p7zip -y &>/dev/null
pkg install xorg-xrandr -y &>/dev/null
pkg install ncurses-utils -y &>/dev/null
pkg install hashdeep -y &>/dev/null
pkg install termux-x11-nightly -y &>/dev/null
pkg install dwm -y &>/dev/null

if [ -e $PREFIX/glibc ]; then
    echo -n "Removing previous glibc. Continue? (Y/n) "
    read i
    if [ "$i" = "Y" ] || [ "$i" = "y" ]; then
        rm -rf $PREFIX/glibc
    else
        return 1
    fi
fi

INSTALL_WOW64=0

echo "Select an option"
echo "1) Install previous boxwine with box86"
echo "2) Install new boxwine wow64 version"
echo ""
echo -n "Selected number: "
read i
case "$i" in
1)
    INSTALL_WOW64=0
;;
2)
    INSTALL_WOW64=1
;;
*)
    return 1
;;
esac

echo "Installing boxwine"

if [ "$INSTALL_WOW64" = "1" ]; then
    wget -q "https://gitlab.com/api/v4/projects/$PROJECT_ID/repository/files/wine-9.3-vanilla-wow64/raw?ref=main" -O $PREFIX/bin/wine
else
    wget -q "https://gitlab.com/api/v4/projects/$PROJECT_ID/repository/files/wine-ge-custom-8-25/raw?ref=main" -O $PREFIX/bin/wine
fi

ln -sf $PREFIX/bin/wine $PREFIX/bin/boxwine

mkdir -p ~/BoxWineConfig
echo "BoxWine Configuration" > ~/BoxWineConfig/config.txt

mkdir -p ~/Desktop
echo "[Desktop Entry]" > ~/Desktop/BoxWine.desktop
echo "Version=1.0" >> ~/Desktop/BoxWine.desktop
echo "Name=BoxWine" >> ~/Desktop/BoxWine.desktop
echo "Exec=boxwine" >> ~/Desktop/BoxWine.desktop
echo "Icon=boxwine" >> ~/Desktop/BoxWine.desktop
echo "Terminal=false" >> ~/Desktop/BoxWine.desktop
echo "Type=Application" >> ~/Desktop/BoxWine.desktop
chmod +x ~/Desktop/BoxWine.desktop

echo "To start - type \"boxwine\""
echo "BoxWine Configuration is available in the ~/BoxWineConfig directory."
