#!/bin/bash

termux-setup-storage &>/dev/null
sleep 2

while [ ! -d "$HOME/storage/shared" ]; do
    echo "Please grant storage access in the prompt." 
    sleep 3
done

packages=(
    x11-repo pulseaudio xwayland wget tsu root-repo patchelf 
    p7zip xorg-xrandr ncurses-utils hashdeep termux-x11-nightly 
)

for pkg in "${packages[@]}"; do
    pkg install "$pkg" -y &>/dev/null
done

mkdir -p $PREFIX/glibc/opt/package-manager/installed

echo "PRIVATE_TOKEN=glpat-9fxsdQ4Fub14JU8xMUot
PROJECT_ID=67947913" > $PREFIX/glibc/opt/package-manager/token

. $PREFIX/glibc/opt/package-manager/token

function wget-git-q {
    wget -q --retry-connrefused --tries=0 --header "PRIVATE-TOKEN: $PRIVATE_TOKEN" \
    "https://gitlab.com/api/v4/projects/$PROJECT_ID/repository/files/$1/raw?ref=main" -O "$2"
}

if ! wget-git-q "package-manager" "$PREFIX/glibc/opt/package-manager/package-manager"; then
    echo "Download failed."
    exit 1
fi

. "$PREFIX/glibc/opt/package-manager/package-manager"
sync-all
sync-package wine-9.3-vanilla-wow64

cat <<EOF > "$PREFIX/bin/boxwine"
#!/bin/bash
echo "Select Language / Выберите язык:"
echo "1) English"
echo "2) Русский"
read -p "Choice / Выбор: " lang_choice

if [ "\$lang_choice" == "2" ]; then
    lang="ru"
else
    lang="en"
fi

function msg() {
    case \$lang in
        en) echo "\$1" ;;
        ru) echo "\$2" ;;
    esac
}

msg "Starting BoxWine..." "Запуск BoxWine..."

export DISPLAY=:0
termux-x11 :0 &
sleep 2

PS3="Select an option / Выберите опцию: "
options=("Start Wine" "Exit")
select opt in "\${options[@]}"
do
    case \$opt in
        "Start Wine")
            msg "Launching Wine..." "Запуск Wine..."
            wine64
            break
            ;;
        "Exit")
            msg "Exiting..." "Выход..."
            break
            ;;
        *) 
            msg "Invalid option." "Неверный выбор."
            ;;
    esac
done
EOF

chmod +x "$PREFIX/bin/boxwine"

echo "Installation complete! To start, type 'boxwine'"
