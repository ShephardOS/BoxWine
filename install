#!/bin/bash

echo "Made by ShephardOS"

echo "Installing termux-am"
pkg install termux-am -y &>/dev/null

termux-setup-storage & sleep 4 &>/dev/null

while true; do
    if [ -d ~/storage/shared ]; then
        break
    else
        echo "Storage permission denied"
    fi
    sleep 3
done

echo "Installing termux packages"
apt-get clean
apt-get update >/dev/null 2>&1
apt-get -y --with-new-pkgs -o Dpkg::Options::="--force-confdef" upgrade >/dev/null 2>&1
pkg install x11-repo -y &>/dev/null
pkg install pulseaudio -y &>/dev/null
pkg install xwayland -y &>/dev/null
pkg install wget -y &>/dev/null
pkg install tsu -y &>/dev/null
pkg install root-repo -y &>/dev/null
pkg install patchelf -y &>/dev/null
pkg install p7zip -y &>/dev/null
pkg install xorg-xrandr -y &>/dev/null
pkg install ncurses-utils -y &>/dev/null
pkg install hashdeep -y &>/dev/null
pkg install termux-x11-nightly -y &>/dev/null

function wget-git-q {
    wget -q --retry-connrefused --tries=0 "https://gitlab.com/api/v4/projects/$PROJECT_ID/repository/files/$1/raw?ref=main" -O $2
    return $?
}

echo "Select BoxWine version:"
echo "1) BoxWine with Box86"
echo "2) BoxWine with WoW64 (no available)"
read -p "Enter choice (1/2): " choice

if [ "$choice" = "1" ]; then
    echo "PROJECT_ID=67947913">$PREFIX/glibc/opt/package-manager/token
else
    echo "WoW64 version is currently not available."
    exit 1
fi

echo "Updating package manager"
mkdir -p $PREFIX/glibc/opt/package-manager/installed

. $PREFIX/glibc/opt/package-manager/token
if ! wget-git-q "package-manager" "$PREFIX/glibc/opt/package-manager/package-manager"; then
    echo "Download failed"
    exit 1
fi
. $PREFIX/glibc/opt/package-manager/package-manager
sync-all
sync-package wine-9.3-vanilla-wow64

mkdir -p $PREFIX/bin
echo 'termux-x11 :1 & export DISPLAY=:1 && startxfce4' > $PREFIX/bin/boxwine
chmod +x $PREFIX/bin/boxwine

echo "To start type boxwine"
