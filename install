#!/bin/bash

rm -f ~/x

echo "Choose language / Выберите язык:"
echo "1) English"
echo "2) Русский"
read -p "Enter number / Введите номер: " LANG_CHOICE

if [[ "$LANG_CHOICE" == "1" ]]; then
    LANG="EN"
elif [[ "$LANG_CHOICE" == "2" ]]; then
    LANG="RU"
else
    echo "Invalid choice / Неверный выбор"
    exit 1
fi

if [[ "$LANG" == "EN" ]]; then
    echo "Installing termux-am"
else
    echo "Установка termux-am"
fi

pkg install termux-am -y &>/dev/null

termux-setup-storage & sleep 4 &>/dev/null

while true; do
    if [ -d ~/storage/shared ]; then
        break
    else
        if [[ "$LANG" == "EN" ]]; then
            echo "Storage access not granted"
        else
            echo "Доступ к хранилищу не предоставлен"
        fi
    fi
    sleep 3
done

if [[ "$LANG" == "EN" ]]; then
    echo "Updating Termux packages..."
else
    echo "Установка пакетов Termux..."
fi

apt-get clean
apt-get update >/dev/null 2>&1
apt-get -y --with-new-pkgs -o Dpkg::Options::="--force-confdef" upgrade >/dev/null 2>&1

PACKAGES=(
    x11-repo pulseaudio xwayland wget tsu root-repo patchelf
    p7zip xorg-xrandr ncurses-utils hashdeep termux-x11-nightly
)

for pkg in "${PACKAGES[@]}"; do
    pkg install "$pkg" -y &>/dev/null
done

if [ -e "$PREFIX/glibc" ]; then
    if [[ "$LANG" == "EN" ]]; then
        echo -n "Remove previous BoxWine? (Y/n) "
    else
        echo -n "Удалить предыдущий BoxWine? (Y/n) "
    fi
    read i
    if [[ "$i" == "Y" || "$i" == "y" ]]; then
        rm -rf "$PREFIX/glibc"
    else
        exit 1
    fi
fi

INSTALL_WOW64=0

if [[ "$LANG" == "EN" ]]; then
    echo "Select installation option:"
    echo "1) Install old BoxWine with box86"
    echo "2) Install new BoxWine (WoW64)"
else
    echo "Выберите вариант установки:"
    echo "1) Установить старый BoxWine с box86"
    echo "2) Установить новый BoxWine (WoW64)"
fi

echo ""
read -p "Enter number / Введите номер: " i
case "$i" in
    1) INSTALL_WOW64=0 ;;
    2) INSTALL_WOW64=1 ;;
    *) exit 1 ;;
esac

if [[ "$LANG" == "EN" ]]; then
    echo "Installing BoxWine..."
else
    echo "Установка BoxWine..."
fi

function wget-git-q {
    wget -q --retry-connrefused --tries=0 "https://gitlab.com/api/v4/projects/$PROJECT_ID/repository/files/$1/raw?ref=main" -O "$2"
    return $?
}

if [[ "$LANG" == "EN" ]]; then
    echo "Updating package manager..."
else
    echo "Обновление менеджера пакетов..."
fi

mkdir -p "$PREFIX/glibc/opt/package-manager/installed"

if [ "$INSTALL_WOW64" -eq 1 ]; then
    echo "PROJECT_ID=54240888" > "$PREFIX/glibc/opt/package-manager/token"
else
    echo "PROJECT_ID=52465323" > "$PREFIX/glibc/opt/package-manager/token"
fi

. "$PREFIX/glibc/opt/package-manager/token"

if ! wget-git-q "package-manager" "$PREFIX/glibc/opt/package-manager/package-manager"; then
    if [[ "$LANG" == "EN" ]]; then
        echo "Download error"
    else
        echo "Ошибка загрузки"
    fi
    exit 1
fi

. "$PREFIX/glibc/opt/package-manager/package-manager"
sync-all

if [ "$INSTALL_WOW64" -eq 1 ]; then
    sync-package wine-9.3-vanilla-wow64
else
    sync-package wine-ge-custom-8-25
fi

ln -sf "$PREFIX/glibc/opt/scripts/boxwine" "$PREFIX/bin/boxwine"

if [[ "$LANG" == "EN" ]]; then
    echo "Installation complete. Use command: boxwine"
else
    echo "Установка завершена. Для запуска используй команду: boxwine"
fi
