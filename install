
#!/bin/bash

rm ~/x

echo "Installing termux-am"
termux-am &>/dev/null

termux-setup-storage & sleep 4 &>/dev/null

while true; do 
  if [ -d ~/storage/shared ]; then 
    break 
  else 
    echo "Storage permission denied" 
  fi 
  sleep 3
done

echo "Installing termux packages"

apt-get clean
apt-get update >/dev/null 2>&1
apt-get -y --with-new-pkgs -o Dpkg::Options::="--force-confdef" upgrade >/dev/null 2>&1

echo "Preparing environment"

mkdir -p $PREFIX/glibc/opt/package-manager/installed

INSTALL_WOW64=0

echo "Select an option"
echo "1) Install previous boxwine with box86"
echo "2) Install new boxwine wow64 version"
echo ""
echo -n "Selected number: "
read i
case "$i" in
1)
  INSTALL_WOW64=0
  ;;
2)
  INSTALL_WOW64=1
  ;;
*)
  return 1
  ;;
esac

echo "Installing boxwine"

function wget-git-q { 
  wget -q --retry-connrefused --tries=0 "https://gitlab.com/api/v4/projects/67374933/repository/files/$1/raw?ref=main" -O $2
  return $?
}

echo "Updating package manager"
mkdir -p $PREFIX/glibc/opt/package-manager/installed

echo "PROJECT_ID=67374933" > $PREFIX/glibc/opt/package-manager/token

. $PREFIX/glibc/opt/package-manager/token
if ! wget-git-q "package-manager" "$PREFIX/glibc/opt/package-manager/package-manager"; then
  echo "Download failed"
  return 1
fi
. $PREFIX/glibc/opt/package-manager/package-manager
sync-all

if [ "$INSTALL_WOW64" = "1" ]; then
  sync-package wine-9.3-vanilla-wow64
else
  sync-package wine-ge-custom-8-25
fi

ln -sf $PREFIX/glibc/opt/scripts/boxwine $PREFIX/bin/boxwine
echo "To start - type \"boxwine\""
