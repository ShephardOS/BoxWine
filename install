#!/bin/bash

echo "Select language / Выберите язык:"
echo "1) English"
echo "2) Русский"
read -p "Choice / Выбор: " lang

if [ "$lang" = "1" ]; then
    MSG_STORAGE="Storage permission denied"
    MSG_UPDATE="Updating package manager"
    MSG_DOWNLOAD_FAILED="Download failed"
elif [ "$lang" = "2" ]; then
    MSG_STORAGE="Доступ к хранилищу отклонен"
    MSG_UPDATE="Обновление менеджера пакетов"
    MSG_DOWNLOAD_FAILED="Не удалось загрузить"
else
    echo "Invalid choice / Неверный выбор"
    exit 1
fi

pkg install termux-am -y &>/dev/null
termux-setup-storage &>/dev/null
sleep 4

while [ ! -d ~/storage/shared ]; do
    echo "$MSG_STORAGE"
    sleep 3
done

apt-get clean
apt-get update >/dev/null 2>&1
apt-get -y --with-new-pkgs -o Dpkg::Options::="--force-confdef" upgrade >/dev/null 2>&1

pkg install x11-repo -y &>/dev/null
pkg install pulseaudio -y &>/dev/null
pkg install xwayland -y &>/dev/null
pkg install wget -y &>/dev/null
pkg install tsu -y &>/dev/null
pkg install root-repo -y &>/dev/null
pkg install patchelf -y &>/dev/null
pkg install p7zip -y &>/dev/null
pkg install xorg-xrandr -y &>/dev/null
pkg install ncurses-utils -y &>/dev/null
pkg install hashdeep -y &>/dev/null
pkg install termux-x11-nightly -y &>/dev/null
pkg install xfce4 -y &>/dev/null

mkdir -p $PREFIX/glibc/opt/package-manager/installed

function wget-git-q {
    wget -q --retry-connrefused --tries=0 "https://gitlab.com/api/v4/projects/$PROJECT_ID/repository/files/$1/raw?ref=main" -O $2
    return $?
}

echo "PROJECT_ID=67947913" > $PREFIX/glibc/opt/package-manager/token

. $PREFIX/glibc/opt/package-manager/token

echo "$MSG_UPDATE"

if ! wget-git-q "package-manager" "$PREFIX/glibc/opt/package-manager/package-manager"; then
    echo "$MSG_DOWNLOAD_FAILED"
    exit 1
fi

. $PREFIX/glibc/opt/package-manager/package-manager

sync-all
sync-package wine-9.3-vanilla-wow64

ln -sf $PREFIX/glibc/opt/scripts/boxwine $PREFIX/bin/boxwine

echo "To start type boxwine"
