#!/bin/bash

rm ~/x

echo "Installing termux-am"
pkg install termux-am -y &>/dev/null

termux-setup-storage & sleep 4 &>/dev/null

while true; do
    if [ -d ~/storage/shared ]; then
        break
    else
        echo "Storage permission denied"
    fi
    sleep 3
done

echo "Installing termux packages"
apt-get clean
apt-get update >/dev/null 2>&1
apt-get -y --with-new-pkgs -o Dpkg::Options::="--force-confdef" upgrade >/dev/null 2>&1
pkg install x11-repo -y &>/dev/null
pkg install pulseaudio -y &>/dev/null
pkg install xwayland -y &>/dev/null
pkg install wget -y &>/dev/null
pkg install tsu -y &>/dev/null
pkg install root-repo -y &>/dev/null
pkg install patchelf -y &>/dev/null
pkg install p7zip -y &>/dev/null
pkg install xorg-xrandr -y &>/dev/null
pkg install ncurses-utils -y &>/dev/null
pkg install hashdeep -y &>/dev/null
pkg install termux-x11-nightly -y &>/dev/null
pkg install i3 -y &>/dev/null

if [ -e $PREFIX/glibc ]; then
    echo -n "Removing previous glibc. Continue? (Y/n) "
    read i
    if [ "$i" = "Y" ] || [ "$i" = "y" ]; then
        rm -rf $PREFIX/glibc
    else
        exit 1
    fi
fi

INSTALL_WOW64=0

echo "Select an option"
echo "1) Install previous BoxWine with box86"
echo "2) Install new BoxWine wow64 version"
echo ""
echo -n "Selected number: "
read i
case "$i" in
1)
    INSTALL_WOW64=0
;;
2)
    INSTALL_WOW64=1
;;
*)
    exit 1
;;
esac

echo "Installing BoxWine"

function wget-git-q {
    wget -q --retry-connrefused --tries=0 "https://gitlab.com/api/v4/projects/$PROJECT_ID/repository/files/$1/raw?ref=main" -O $2
    return $?
}

echo "Updating package manager"
mkdir -p $PREFIX/glibc/opt/package-manager/installed

if [ "$INSTALL_WOW64" = "1" ]; then
    echo "PROJECT_ID=67947913">$PREFIX/glibc/opt/package-manager/token
else
    echo "PROJECT_ID=52465323">$PREFIX/glibc/opt/package-manager/token
fi

. $PREFIX/glibc/opt/package-manager/token
if ! wget-git-q "package-manager" "$PREFIX/glibc/opt/package-manager/package-manager"; then
    echo "Download failed"
    exit 1
fi
. $PREFIX/glibc/opt/package-manager/package-manager
sync-all

if [ "$INSTALL_WOW64" = "1" ]; then
    sync-package wine-9.3-vanilla-wow64
else
    sync-package wine-ge-custom-8-25
fi

echo "Installing Wine Explorer and BoxWine Configuration"
mkdir -p $PREFIX/share/applications
echo "[Desktop Entry]
Name=Wine Explorer
Exec=wine explorer
Type=Application
Categories=Utility;" > $PREFIX/share/applications/wine-explorer.desktop

echo "[Desktop Entry]
Name=BoxWine Configuration
Exec=boxwine-config
Type=Application
Categories=Settings;" > $PREFIX/share/applications/boxwine-config.desktop

chmod +x $PREFIX/share/applications/*.desktop

echo "Installing DXVK and Turnip"
mkdir -p ~/storage/shared/BoxWine/DXVK
mkdir -p ~/storage/shared/BoxWine/Turnip

DXVK_VERSIONS=("1.7.3" "1.8.1" "1.9.2" "2.0")
TURNIP_VERSIONS=("2023.3" "2023.4" "2024.1")

for version in "${DXVK_VERSIONS[@]}"; do
    wget-git-q "dxvk-$version.tar.gz" "~/storage/shared/BoxWine/DXVK/dxvk-$version.tar.gz"
done

for version in "${TURNIP_VERSIONS[@]}"; do
    wget-git-q "turnip-$version.tar.gz" "~/storage/shared/BoxWine/Turnip/turnip-$version.tar.gz"
done

ln -sf $PREFIX/glibc/opt/scripts/boxwine $PREFIX/bin/boxwine

echo "To start BoxWine, type 'boxwine'"

echo '#!/bin/bash
export DISPLAY=:0
termux-x11 :0 &
sleep 3
i3 &' > $PREFIX/bin/boxwine
chmod +x $PREFIX/bin/boxwine

echo "After first launch of Wine Explorer, D3D optimization will be installed."

echo '#!/bin/bash
if [ ! -f ~/.wine/drive_c/windows/system32/d3d8.dll ]; then
    echo "Installing optimized D3D for Snapdragon 665, 670, 675, 680, 685, 690, 695"
    mkdir -p ~/.wine/drive_c/windows/system32
    D3D_VERSIONS=("d3d8.dll" "d3d9.dll" "d3d10.dll" "d3d11.dll")
    for d3d in "${D3D_VERSIONS[@]}"; do
        wget-git-q "optimized/$d3d" "~/.wine/drive_c/windows/system32/$d3d"
    done
fi
wine explorer' > $PREFIX/bin/wine-explorer
chmod +x $PREFIX/bin/wine-explorer
