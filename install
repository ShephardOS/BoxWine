#!/data/data/com.termux/files/usr/bin/bash

set -e

echo "Настройка доступа к хранилищу..."
termux-setup-storage &>/dev/null & sleep 4

while [ ! -d ~/storage/shared ]; do
    echo "Ожидание доступа к хранилищу..."
    sleep 3
done

echo "Обновление пакетов..."
pkg update -y
pkg upgrade -y

echo "Установка репозиториев и пакетов..."

pkg install x11-repo
pkg install termux-x11-nightly
pkg install pulseaudio
pkg install xwayland
pkg install wget
pkg install tsu
pkg install root-repo
pkg install patchelf
pkg install p7zip
pkg install xorg-xrandr
pkg install ncurses-utils
pkg install hashdeep
pkg install xfce4
pkg install tur-repo
pkg install chromium
pkg install code-oss

if [ -d "$PREFIX/glibc" ]; then
    echo -n "Найдена старая glibc. Удалить? (Y/n): "
    read answer
    if [[ "$answer" =~ ^[Yy]$ ]]; then
        rm -rf "$PREFIX/glibc"
        echo "Старая glibc удалена."
    else
        echo "Установка прервана."
        exit 1
    fi
fi

echo
echo "Выберите версию BoxWine для установки:"
echo "1) Box86 (32-bit)"
echo "2) Wow64 (64-bit)"
read -p "Введите номер (1 или 2): " choice

if [ "$choice" == "2" ]; then
    echo "Скачиваем и распаковываем Wow64 glibc..."
    wget -q --show-progress -O $PREFIX/glibc.wow64.tar.xz https://github.com/ShephardOS/BoxWine/releases/download/Glibc/glibc.wow64.tar.xz
    tar -xf $PREFIX/glibc.wow64.tar.xz -C $PREFIX
    rm $PREFIX/glibc.wow64.tar.xz
else
    echo "Скачиваем и распаковываем Box86 glibc..."
    wget -q --show-progress -O $PREFIX/glibc.box86.tar.xz https://github.com/ShephardOS/BoxWine/releases/download/Glibc/glibc.box86.tar.xz
    tar -xf $PREFIX/glibc.box86.tar.xz -C $PREFIX
    rm $PREFIX/glibc.box86.tar.xz
fi

cp $PREFIX/glibc/opt/scripts/boxwine $PREFIX/bin/
chmod +x $PREFIX/glibc/opt/scripts/*
chmod 777 $PREFIX/bin/boxwine

echo "Скачиваем скрипты и ярлыки..."

wget -q --show-progress https://raw.githubusercontent.com/LinuxDroidMaster/Termux-Desktops/main/scripts/termux_native/startxfce4_termux.sh -O startxfce4_termux.sh
chmod +x startxfce4_termux.sh

wget -q --show-progress https://raw.githubusercontent.com/LinuxDroidMaster/Termux-Desktops/main/scripts/termux_native/mobox_run.sh -O mobox_run.sh
chmod +x mobox_run.sh

mkdir -p ~/Desktop
wget -q --show-progress https://raw.githubusercontent.com/LinuxDroidMaster/Termux-Desktops/main/scripts/termux_native/MoboxExplorer.desktop -P ~/Desktop

echo
echo "Установка завершена!"
echo "Запуск XFCE4: ./startxfce4_termux.sh"
echo "Запуск WineExplorer: ./mobox_run.sh"
