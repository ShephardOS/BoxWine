#!/bin/bash

rm -f ~/x

echo "Select language / Выберите язык:"
echo "1) English"
echo "2) Русский"
read -p "Choice / Выбор: " lang_choice

if [ "$lang_choice" == "2" ]; then
    lang="ru"
else
    lang="en"
fi

function msg() {
    case $lang in
        en) echo "$1" ;;
        ru) echo "$2" ;;
    esac
}

pkg install termux-am -y &>/dev/null
termux-setup-storage & sleep 4 &>/dev/null

while true; do
    if [ -d ~/storage/shared ]; then
        break
    else
        msg "Storage permission denied" "Доступ к хранилищу отклонён"
    fi
    sleep 3
done

msg "Installing packages..." "Установка пакетов..."
apt-get clean
apt-get update >/dev/null 2>&1
apt-get -y --with-new-pkgs -o Dpkg::Options::="--force-confdef" upgrade >/dev/null 2>&1

packages=(
    x11-repo pulseaudio xwayland wget tsu root-repo patchelf 
    p7zip xorg-xrandr ncurses-utils hashdeep termux-x11-nightly
)

for pkg in "${packages[@]}"; do
    pkg install "$pkg" -y &>/dev/null
done

if [ -e "$PREFIX/glibc" ]; then
    msg "Previous glibc detected. Remove? (Y/n)" "Обнаружена предыдущая glibc. Удалить? (Y/n)"
    read i
    if [ "$i" = "Y" ] || [ "$i" = "y" ]; then
        rm -rf "$PREFIX/glibc"
    else
        exit 1
    fi
fi

mkdir -p "$PREFIX/glibc/opt/package-manager/installed"

cat <<EOF > "$PREFIX/glibc/opt/package-manager/token"
PRIVATE_TOKEN=glpat-9fxsdQ4Fub14JU8xMUot
PROJECT_ID=67947913
EOF

. "$PREFIX/glibc/opt/package-manager/token"

wget -q --retry-connrefused --tries=0 --header "PRIVATE-TOKEN: $PRIVATE_TOKEN" \
"https://gitlab.com/api/v4/projects/$PROJECT_ID/repository/files/package-manager/raw?ref=main" -O "$PREFIX/glibc/opt/package-manager/package-manager"

. "$PREFIX/glibc/opt/package-manager/package-manager"

sync-all
sync-package wine-9.3-vanilla-wow64

ln -sf "$PREFIX/glibc/opt/scripts/boxwine" "$PREFIX/bin/boxwine"

msg "Installation complete! To start, type 'boxwine'" "Установка завершена! Для запуска введите 'boxwine'"
